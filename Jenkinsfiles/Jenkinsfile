node {    

    def image

    stage('Clone repository') {               

        checkout scm   
        sh "pwd"
        sh "ls"
    } 

    stage('Test') {

        try {
            sh 'make test'
        } catch(err) {
            throw(err)
        }
    }

    stage('Build image') {         
       
        image = docker.build("erizzardi/http-service:${BUILD_NUMBER}")
    }

    stage('Push image') {

        docker.withRegistry('https://registry.hub.docker.com/', 'docker-hub') {
        
            docker.build('erizzardi/http-service').push("${BUILD_NUMBER}")
        }
    }
}